<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Downtime Guard – Dashboard</title>
  <meta name="description" content="Operational dashboard for AI Downtime Guard" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><circle cx='64' cy='64' r='60' fill='%231f2937'/><text x='64' y='76' font-size='72' text-anchor='middle' fill='%23a3e635'>A</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80',
              500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d',
            }
          }
        }
      },
      darkMode: 'media',
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .card { box-shadow: 0 2px 14px rgba(0,0,0,0.08); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100">
  <header class="bg-gradient-to-r from-brand-600 via-emerald-600 to-teal-600 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-lg bg-white/10 grid place-items-center"> 
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5l-9 15m15-15l-4.5 7.5m-1.5 2.5l-3 5" />
            </svg>
          </div>
          <div>
            <h1 class="text-xl sm:text-2xl font-semibold">AI Downtime Guard</h1>
            <p class="text-white/80 text-sm">Live risk posture and actions</p>
          </div>
        </div>
        <a href="/docs" class="hidden sm:inline-flex items-center gap-2 bg-white/10 hover:bg-white/20 transition-colors px-3 py-1.5 rounded-md">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5m-16.5 10.5h16.5M12 6.75v10.5"/></svg>
          <span>API Docs</span>
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="card rounded-xl bg-white dark:bg-gray-900 p-6 border border-gray-100 dark:border-gray-800">
        <div class="flex items-start justify-between">
          <div>
            <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400">Current Risk</h2>
            <div class="mt-2 flex items-center gap-3">
              <span id="riskBadge" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">LOW</span>
              <span id="riskReason" class="text-gray-600 dark:text-gray-300 text-sm">booting…</span>
            </div>
          </div>
          <div class="text-right">
            <p class="text-sm text-gray-500 dark:text-gray-400">Last update</p>
            <p id="lastUpdate" class="font-medium">—</p>
          </div>
        </div>
        <dl class="mt-6 grid grid-cols-3 gap-4 text-sm">
          <div>
            <dt class="text-gray-500 dark:text-gray-400">API Latency</dt>
            <dd id="apiLatency" class="mt-1 font-semibold">—</dd>
          </div>
          <div>
            <dt class="text-gray-500 dark:text-gray-400">Polling</dt>
            <dd class="mt-1"><span id="pollEvery">2s</span></dd>
          </div>
          <div>
            <dt class="text-gray-500 dark:text-gray-400">Recoveries</dt>
            <dd id="recoveryCount" class="mt-1 font-semibold">0</dd>
          </div>
        </dl>
        <div class="mt-6 flex items-center gap-2">
          <label for="interval" class="text-sm text-gray-600 dark:text-gray-300">Interval</label>
          <select id="interval" class="text-sm px-2 py-1 rounded-md bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
            <option value="2000">2s</option>
            <option value="5000">5s</option>
            <option value="10000">10s</option>
          </select>
          <button id="pauseBtn" class="ml-auto inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-gray-900 text-white dark:bg-white dark:text-gray-900 hover:opacity-90">Pause</button>
        </div>
      </div>

      <div class="card rounded-xl bg-white dark:bg-gray-900 p-6 border border-gray-100 dark:border-gray-800 lg:col-span-2">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400">Risk Over Time</h2>
          <div class="text-xs text-gray-500 dark:text-gray-400">Last 100 points</div>
        </div>
        <div class="mt-4">
          <canvas id="riskChart" height="120"></canvas>
        </div>
        <p class="mt-3 text-xs text-gray-500 dark:text-gray-400">Levels: 0=LOW, 1=MEDIUM, 2=HIGH</p>
      </div>

      <div class="card rounded-xl bg-white dark:bg-gray-900 p-6 border border-gray-100 dark:border-gray-800 lg:col-span-2">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400">Recent Recoveries</h2>
          <button id="refreshState" class="inline-flex items-center gap-2 text-sm px-3 py-1.5 rounded-md bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700">Refresh</button>
        </div>
        <ul id="recoveryList" class="mt-4 divide-y divide-gray-100 dark:divide-gray-800"></ul>
        <p id="noRecovery" class="mt-2 text-sm text-gray-500 dark:text-gray-400 hidden">No recoveries yet.</p>
      </div>

      <div class="card rounded-xl bg-white dark:bg-gray-900 p-6 border border-gray-100 dark:border-gray-800">
        <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400">Synthetic Actions</h2>
        <div class="mt-4 space-y-3">
          <div class="flex items-center gap-2">
            <label class="text-sm w-28">CPU Load</label>
            <input id="loadSeconds" type="number" min="1" max="30" value="5" class="w-24 text-sm px-2 py-1 rounded-md bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700" />
            <button id="btnLoad" class="ml-auto inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-amber-600 text-white hover:bg-amber-700">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v18m9-9H3"/></svg>
              Trigger
            </button>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm w-28">Simulate Error</label>
            <button id="btnError" class="ml-auto inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-rose-600 text-white hover:bg-rose-700">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M4.5 19.5l15-15"/></svg>
              Throw 500
            </button>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm w-28">Crash App</label>
            <button id="btnCrash" class="ml-auto inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-gray-900 text-white dark:bg-white dark:text-gray-900 hover:opacity-90">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
              Exit 1
            </button>
          </div>
          <p id="actionMsg" class="text-xs text-gray-500 dark:text-gray-400"></p>
        </div>
      </div>
    </section>
  </main>

  <footer class="py-6 text-center text-sm text-gray-500 dark:text-gray-400">
    <p>© <span id="year"></span> AI Downtime Guard</p>
  </footer>

  <script>
    const $ = sel => document.querySelector(sel);
    const riskBadge = $('#riskBadge');
    const riskReason = $('#riskReason');
    const lastUpdate = $('#lastUpdate');
    const recoveryCount = $('#recoveryCount');
    const recoveryList = $('#recoveryList');
    const noRecovery = $('#noRecovery');
    const apiLatency = $('#apiLatency');
    const pollEvery = $('#pollEvery');
    const intervalSel = $('#interval');
    const pauseBtn = $('#pauseBtn');
    const refreshState = $('#refreshState');

    const btnLoad = $('#btnLoad');
    const btnError = $('#btnError');
    const btnCrash = $('#btnCrash');
    const loadSeconds = $('#loadSeconds');
    const actionMsg = $('#actionMsg');

    const levelToNum = l => ({LOW:0, MEDIUM:1, HIGH:2})[l] ?? 0;

    // Chart setup
    const ctx = document.getElementById('riskChart');
    const riskChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{
        label: 'Risk Level',
        data: [],
        fill: true,
        borderColor: '#10b981',
        backgroundColor: 'rgba(16,185,129,0.15)',
        tension: 0.35,
        pointRadius: 0,
      }]},
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { suggestedMin: -0.1, suggestedMax: 2.1, ticks: { stepSize: 1 } },
          x: { display: false }
        },
        plugins: { legend: { display: false } }
      }
    });

    function setBadge(level) {
      const cls = {
        LOW: ['bg-emerald-100','text-emerald-700','dark:bg-emerald-900/30','dark:text-emerald-300'],
        MEDIUM: ['bg-amber-100','text-amber-800','dark:bg-amber-900/30','dark:text-amber-300'],
        HIGH: ['bg-rose-100','text-rose-800','dark:bg-rose-900/30','dark:text-rose-300'],
      }[level] || ['bg-gray-100','text-gray-800','dark:bg-gray-800','dark:text-gray-200'];
      riskBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ' + cls.join(' ');
      riskBadge.textContent = level;
    }

    async function fetchJSON(path) {
      const t0 = performance.now();
      const res = await fetch(path, { cache: 'no-cache' });
      const json = await res.json();
      const t1 = performance.now();
      apiLatency.textContent = (t1 - t0).toFixed(0) + ' ms';
      return json;
    }

    async function updateHealth() {
      try {
        const h = await fetchJSON('/health');
        setBadge(h.risk_level);
        riskReason.textContent = h.reason;
        lastUpdate.textContent = new Date(h.timestamp).toLocaleTimeString();

        const nowLabel = new Date().toLocaleTimeString();
        const d = riskChart.data;
        d.labels.push(nowLabel);
        d.datasets[0].data.push(levelToNum(h.risk_level));
        if (d.labels.length > 100) { d.labels.shift(); d.datasets[0].data.shift(); }
        riskChart.update('none');
      } catch (e) {
        console.error(e);
      }
    }

    async function updateState() {
      try {
        const s = await fetchJSON('/state');
        const recs = s.recent_recoveries || [];
        recoveryCount.textContent = recs.length;
        recoveryList.innerHTML = '';
        if (!recs.length) {
          noRecovery.classList.remove('hidden');
        } else {
          noRecovery.classList.add('hidden');
          for (const r of recs.slice().reverse().slice(0, 10)) {
            const li = document.createElement('li');
            li.className = 'py-2 flex items-start justify-between';
            const ts = new Date(r.timestamp).toLocaleString();
            li.innerHTML = `<div class="text-sm">${r.reason}</div><div class="text-xs text-gray-500 dark:text-gray-400">${ts}</div>`;
            recoveryList.appendChild(li);
          }
        }
      } catch (e) {
        console.error(e);
      }
    }

    let timer = null;
    function startPolling() {
      stopPolling();
      const ms = parseInt(intervalSel.value, 10);
      pollEvery.textContent = Math.round(ms/1000) + 's';
      timer = setInterval(updateHealth, ms);
      pauseBtn.textContent = 'Pause';
      pauseBtn.dataset.paused = '0';
    }
    function stopPolling() { if (timer) { clearInterval(timer); timer = null; } }

    intervalSel.addEventListener('change', startPolling);
    pauseBtn.addEventListener('click', () => {
      if (pauseBtn.dataset.paused === '1') { startPolling(); }
      else { stopPolling(); pauseBtn.textContent = 'Resume'; pauseBtn.dataset.paused = '1'; }
    });
    refreshState.addEventListener('click', updateState);

    btnLoad.addEventListener('click', async () => {
      const seconds = Math.max(1, Math.min(30, parseInt(loadSeconds.value || '5', 10)));
      actionMsg.textContent = 'Triggering load…';
      try { const r = await fetch(`/load?seconds=${seconds}`); const j = await r.json(); actionMsg.textContent = j.message || 'Load triggered'; }
      catch { actionMsg.textContent = 'Failed to trigger load'; }
    });
    btnError.addEventListener('click', async () => {
      actionMsg.textContent = 'Triggering error…';
      try { await fetch('/error'); actionMsg.textContent = 'Error endpoint returned'; }
      catch { actionMsg.textContent = 'Error simulated (500)'; }
    });
    btnCrash.addEventListener('click', async () => {
      if (!confirm('This will terminate the server process. Continue?')) return;
      actionMsg.textContent = 'Crashing app…';
      try { await fetch('/crash'); actionMsg.textContent = 'Crash requested'; }
      catch { actionMsg.textContent = 'Crash likely executed'; }
    });

    // Init
    document.getElementById('year').textContent = new Date().getFullYear();
    updateHealth();
    updateState();
    startPolling();
  </script>
</body>
</html>
